test_that("volSmry_byC.R: volumes are not correctly summarized at cluster level.", {
  library(data.table)
  library(testthat)
  teptable <- data.table(CLSTR_ID = c("0251-0001-MO1", "0251-0001-MO1",
                                      "0251-0001-MO1", "0251-0001-MO1", "0252-0107-TO1", "0252-0107-TO1",
                                      "0252-0107-TO1", "0252-0107-TO1", "0251-0001-MO1", "0251-0001-MO1",
                                      "0251-0001-MO1", "0252-0107-TO1", "0252-0107-TO1", "0252-0107-TO1",
                                      "0251-0001-MO1", "0251-0001-MO1", "0251-0001-MO1", "0252-0107-TO1",
                                      "0252-0107-TO1", "0251-0001-MO1", "0251-0001-MO1", "0252-0107-TO1",
                                      "0252-0107-TO1", "0251-0001-MO1", "0252-0107-TO1"),
                         SPECIES = c("HM", "PLC", "PLI", "YC", "CW", "PLC", "XC", "YC", "HM", "PLC", "YC",
                                     "CW", "PLC", "YC", "HM", "PLC", "YC", "CW", "PLC", "PLC", "YC",
                                     "CW", "PLC", "PLC", "CW"),
                         NO_PLOTS = c(1, 1, 1, 1, 5, 5, 5, 5, 1, 1, 1, 5, 5, 5, 1, 1, 1, 5, 5, 1, 1, 5,
                                      5, 1, 5),
                         PLOT_DED = c(1, 1, 1, 1, 5, 5, 5, 5, 1, 1, 1, 5, 5,
                                      5, 1, 1, 1, 5, 5, 1, 1, 5, 5, 1, 5),
                         BEC_ZONE = c("CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH",
                                      "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH", "CWH",
                                      "CWH", "CWH", "CWH", "CWH", "CWH", "CWH"),
                         VHA_WSV_LS = c(1.609, 66.853, 0.416, 19.165, 10.212, 15.896, 0, 0.998, 1.609, 64.303,
                                     9.106, 9.536, 11.897, 0.852, 1.609, 55.208, 1.884, 8.819, 7.573,
                                     44.995, 0, 8.819, 3.558, 38.564, 8.819),
                         VHA_MER_LS = c(1.108, 50.88, 0, 3.267, 7.826,
                                     6.873, 0, 0.034, 1.108, 50.88, 3.267, 7.826, 6.873, 0.034, 1.108,
                                     47.492, 1.432, 7.653, 5.843, 40.322, 0, 7.653, 2.909, 34.925,
                                     7.653),
                         VHA_NTWB_LS = c(1.052, 49.862, 0, 3.038, 7.146, 8.307, 0,
                                      0.016, 1.052, 49.862, 3.038, 7.146, 8.307, 0.016, 1.052,
                                      46.542, 1.332, 7.146, 6.941, 39.516, 0, 7.146, 3.261, 34.226,
                                      7.146),
                         VHA_DWB_LS = c(1.048, 46.237, 0, 3.02, 7.232, 7.502,
                                     0, 0.016, 1.048, 46.237, 3.02, 7.232, 7.502, 0.016, 1.048,
                                     43.048, 1.323, 7.232, 6.263, 36.301, 0, 7.232, 2.942, 31.255,
                                     7.232),
                         DBH2_LS = c(4903.295,
                                  212313.163, 2810.889, 73338.53, 32057.141, 88257.705, 0,
                                  4355.327, 4903.295, 197062.916, 31805.622, 28307.021, 60335.943,
                                  3749.92, 4903.295, 158045.949, 6404.303, 24618.142, 34651.284,
                                  120438.929, 0, 24618.142, 16010.758, 99910.635, 24618.142),
                         BA_HA_LS = c(0.385, 16.675, 0.221, 5.76, 2.518, 6.932, 0,
                                   0.342, 0.385, 15.477, 2.498, 2.223, 4.739, 0.295, 0.385,
                                   12.413, 0.503, 1.934, 2.722, 9.459, 0, 1.934, 1.257, 7.847,
                                   1.934),
                         STEMS_HA_LS = c(25, 1201, 100, 1326, 200, 1241, 0, 80,
                                      25, 700, 325, 80, 420, 60, 25, 350, 25, 40, 120, 175, 0,
                                      40, 40, 125, 40),
                         VHA_WSV_LF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         VHA_MER_LF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         VHA_NTWB_LF = c(0,
                                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                        0, 0, 0, 0, 0),
                         VHA_DWB_LF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         DBH2_LF = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         BA_HA_LF = c(0,
                                     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                     0, 0, 0, 0, 0),
                         STEMS_HA_LF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         VHA_WSV_DS = c(0,
                                       2.016, 0, 11.062, 0, 3.481, 0.328, 0.903, 0, 2.016, 9.942,
                                       0, 2.207, 0.453, 0, 2.016, 7.844, 0, 1.463, 2.016, 3.027,
                                       0, 0, 0, 0),
                         VHA_MER_DS = c(0, 1.613,
                                       0, 6.393, 0, 0.862, 0, 0.158, 0, 1.613, 6.393, 0, 0.862,
                                       0.158, 0, 1.613, 5.534, 0, 0.862, 1.613, 2.457, 0, 0, 0,
                                       0),
                         VHA_NTWB_DS = c(0, 1.565,
                                        0, 5.649, 0, 1.308, 0, 0, 0, 1.565, 5.649, 0, 1.308, 0, 0,
                                        1.565, 4.887, 0, 1.308, 1.565, 2.162, 0, 0, 0, 0),
                         VHA_DWB_DS = c(0, 1.513, 0, 5.915, 0, 1.25, 0, 0, 0, 1.513,
                                       5.915, 0, 1.25, 0, 0, 1.513, 5.12, 0, 1.25, 1.513, 2.273,
                                       0, 0, 0, 0),
                         DBH2_DS = c(0, 8286.568,
                                    0, 30821.46, 0, 19992.834, 2211.486, 3886.211, 0, 8286.568,
                                    26593.62, 0, 11351.628, 1922.092, 0, 8286.568, 20946.575,
                                    0, 6354.67, 8286.568, 7661.398, 0, 0, 0, 0),
                         BA_HA_DS = c(0,
                                     0.651, 0, 2.421, 0, 1.57, 0.174, 0.305, 0, 0.651, 2.089,
                                     0, 0.892, 0.151, 0, 0.651, 1.645, 0, 0.499, 0.651, 0.602,
                                     0, 0, 0, 0),
                         STEMS_HA_DS = c(0, 25, 0, 250, 0, 360, 80, 80,
                                        0, 25, 150, 0, 120, 20, 0, 25, 100, 0, 40, 25, 25, 0, 0,
                                        0, 0),
                         VHA_WSV_DF = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         VHA_MER_DF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         VHA_NTWB_DF = c(0,
                                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                        0, 0, 0, 0, 0),
                         VHA_DWB_DF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         DBH2_DF = c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                    0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         BA_HA_DF = c(0,
                                     0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                     0, 0, 0, 0, 0),
                         STEMS_HA_DF = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
                                        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         UTIL = c(4,
                                  4, 4, 4, 4, 4, 4, 4, 7.5, 7.5, 7.5, 7.5, 7.5, 7.5, 12.5,
                                  12.5, 12.5, 12.5, 12.5, 17.5, 17.5, 17.5, 17.5, 22.5, 22.5),
                         QMD_LS = c(14, 13.297, 5.3, 7.437, 12.656, 8.434, 0, 7.376,
                                 14, 16.773, 9.889, 18.804, 11.982, 7.903, 14, 21.243, 16,
                                 24.8, 16.987, 26.225, 0, 24.8, 20, 28.262, 24.8),
                         QMD_LF = c(0,
                                   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                                   0, 0, 0, 0, 0),
                         QMD_DS = c(0, 18.2, 0, 11.1, 0, 7.45, 5.256,
                                   6.967, 0, 18.2, 13.311, 0, 9.723, 9.8, 0, 18.2, 14.468, 0,
                                   12.6, 18.2, 17.5, 0, 0, 0, 0),
                         QMD_DF = c(0, 0, 0, 0, 0, 0,
                                   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0),
                         NO_TREES = c(1, 31, 1, 24, 5, 47, 2, 8, 1, 26, 13, 2, 17,
                                      4, 1, 15, 5, 1, 4, 8, 1, 1, 1, 5, 1))
  teptable[, ':='(VHA_WSV_GVAF_LS = VHA_WSV_LS,
                  VHA_WSV_GVAF_DS = VHA_WSV_DS,
                  VHA_MER_GVAF_LS = VHA_MER_LS,
                  VHA_MER_GVAF_DS = VHA_MER_DS,
                  VHA_NTWB_NVAF_LS = VHA_NTWB_LS,
                  VHA_NTWB_NVAF_DS = VHA_NTWB_DS)]
  volsummarybyc <- volSmry_byC(teptable)
  ## for VHA_WSV
  expect_equal(volsummarybyc$VHA_WSV_LS,
               c(88.043, 75.018, 58.701, 44.995, 38.564, 27.106, 22.285,
                 16.392, 12.377, 8.819))
  # for VHA_MER
  expect_equal(volsummarybyc$VHA_MER_LS,
               c(55.255, 55.255, 50.032, 40.322, 34.925, 14.733, 14.733,
                 13.496, 10.562, 7.653))
  # for VHA_NTWB
  expect_equal(volsummarybyc$VHA_NTWB_LS,
               c(53.952, 53.952, 48.926, 39.516, 34.226, 15.469, 15.469,
                 14.087, 10.407, 7.146))
  # for VHA_DWB
  expect_equal(volsummarybyc$VHA_DWB_LS,
               c(50.305, 50.305, 45.419, 36.301, 31.255, 14.750, 14.750,
                 13.495, 10.174, 7.232))
  # for BA_HA
  expect_equal(volsummarybyc$BA_HA_LS,
               c(23.041, 18.36, 13.301, 9.459, 7.847, 9.792, 7.257,
                 4.656, 3.191, 1.934))
  # for STEMS_HA
  expect_equal(volsummarybyc$STEMS_HA_LS,
               c(2652, 1050, 400, 175, 125, 1521, 560, 160, 80, 40))

  ## for all the live falling trees
  for(i in c("VHA_WSV_LF", "VHA_MER_LF", "VHA_NTWB_LF", "VHA_DWB_LF",
             "BA_HA_LF", "STEMS_HA_LF")){
    expect_equal(as.numeric(unlist(volsummarybyc[,i, with = FALSE])),
                 rep(0, 10))
  }

  # for VHA_WSVDS
  expect_equal(volsummarybyc$VHA_WSV_DS,
               c(13.078, 11.958, 9.86, 5.043, 0, 4.712, 2.660, 1.463,
                 0, 0))
  # for VHA_MERDS
  expect_equal(volsummarybyc$VHA_MER_DS,
               c(8.006, 8.006, 7.147, 4.070, 0, 1.02, 1.02, 0.862,
                 0, 0))
  # VHA_NTWBDS
  expect_equal(volsummarybyc$VHA_NTWB_DS,
               c(7.214, 7.214, 6.452, 3.727, 0, 1.308, 1.308, 1.308,
                 0, 0))
  # for VHA_DWBDS
  expect_equal(volsummarybyc$VHA_DWB_DS,
               c(7.428, 7.428, 6.633, 3.786, 0, 1.25, 1.25, 1.25,
                 0, 0))
  # for BA_HADS
  expect_equal(volsummarybyc$BA_HA_DS,
               c(3.072, 2.740, 2.296, 1.253, 0, 2.049, 1.043, 0.499,
                 0, 0))
  # for STEMS_HADS
  expect_equal(volsummarybyc$STEMS_HA_DS,
               c(275, 175, 125, 50, 0, 520, 140, 40, 0, 0))
  ### for dead falling trees
  for(i in c("VHA_WSV_DF", "VHA_MER_DF", "VHA_NTWB_DF", "VHA_DWB_DF",
             "DBH2_DF", "BA_HA_DF", "STEMS_HA_DF")){
    expect_equal(as.numeric(unlist(volsummarybyc[,i, with = FALSE])),
                 rep(0, 10))
  }

  # for QMD
  expect_equal(volsummarybyc$QMD_LS,
               c(10.518, 14.921, 20.576, 26.234, 28.272, 9.054, 12.845, 19.247,
                 22.536, 24.808))
  # for QMDLF
  expect_equal(volsummarybyc$QMD_LF, rep(as.numeric(0), 10))
  # for QMDDS
  expect_equal(volsummarybyc$QMD_DS,
               c(11.925, 14.118, 15.293, 17.859, 0, 7.083, 9.737, 12.604, 0,
                 0))
  # for gvaf adjusted wsv and mer
  expect_equal(volsummarybyc$VHA_WSV_GVAF_LS,
               c(88.043, 75.018, 58.701, 44.995, 38.564, 27.106, 22.285,
                 16.392, 12.377, 8.819))
  expect_equal(volsummarybyc$VHA_MER_GVAF_LS,
               c(55.255, 55.255, 50.032, 40.322, 34.925, 14.733, 14.733,
                 13.496, 10.562, 7.653))
  expect_equal(volsummarybyc$VHA_WSV_GVAF_DS,
               c(13.078, 11.958, 9.86, 5.043, 0, 4.712, 2.660, 1.463,
                 0, 0))
  expect_equal(volsummarybyc$VHA_MER_GVAF_DS,
               c(8.006, 8.006, 7.147, 4.070, 0, 1.02, 1.02, 0.862,
                 0, 0))
})
